# serverless.yml
service: customer-api

frameworkVersion: '^4.0.0'

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-south-1 # Change to your preferred region
  stage: dev

  # Environment variables holding the DB credentials (fetched from Secrets Manager)
  # You will need to replace the ARN with your actual secret ARN.
  environment:
    DB_HOST: ecommerce-database.cjaiucq4yz33.ap-south-1.rds.amazonaws.com
    DB_USER: ${ssm:/aws/reference/secretsmanager/arn:aws:secretsmanager:ap-south-1:887344123213:secret:rds!db-65d51ec6-b62a-4bf3-b65f-ff81ac389940-t3yIjb~true:username}
    DB_PASSWORD: ${ssm:/aws/reference/secretsmanager/arn:aws:secretsmanager:ap-south-1:887344123213:secret:rds!db-65d51ec6-b62a-4bf3-b65f-ff81ac389940-t3yIjb~true:password}
    DB_NAME: postgres

  # Permissions for Lambda to access Secrets Manager and operate within the VPC
  iam:
    role:
      statements:
        - Effect: "Allow"
          Action:
            - "secretsmanager:GetSecretValue"
          Resource: "arn:aws:secretsmanager:REGION:ACCOUNT_ID:secret:SECRET_NAME-???????" # Replace with your Secret's ARN
        - Effect: "Allow"
          Action:
            - "ec2:CreateNetworkInterface"
            - "ec2:DescribeNetworkInterfaces"
            - "ec2:DeleteNetworkInterface"
          Resource: "*"

  # VPC configuration to connect Lambda to RDS
  # Replace with your actual VPC, Subnet, and Security Group IDs
  vpc:
    securityGroupIds:
      - sg-0123456789abcdef0 # Your lambda-sg ID
    subnetIds:
      - subnet-0123456789abcdef0 # A private subnet in your VPC
      - subnet-fedcba9876543210f # Another private subnet for HA

plugins:
  - serverless-offline # For local testing

functions:
  createCustomer:
    handler: handler.createCustomer
    events:
      - http:
          path: customer
          method: post
          cors: true
  
  getCustomer:
    handler: handler.getCustomer
    events:
      - http:
          path: customer/{username}
          method: get
          cors: true

  updateCustomer:
    handler: handler.updateCustomer
    events:
      - http:
          path: customer/{username}
          method: put
          cors: true
          
  deleteCustomer:
    handler: handler.deleteCustomer
    events:
      - http:
          path: customer/{username}
          method: delete
          cors: true